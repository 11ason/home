<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NowPlaying</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Roboto:wght@400;700&family=Lato:wght@400;700&family=Merriweather:wght@400;700&family=Fira+Sans:wght@400;700&family=Nunito:wght@400;700&family=Ubuntu:wght@400;700&family=Funnel+Display:wght@400;700&display=swap" rel="stylesheet">

<style>
body {
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    height:100vh;
    margin:0;
    font-family:"Inter",sans-serif;
    background:#000;
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
    transition:background-image 1s ease;
    backdrop-filter:blur(100px);
}

.main-container {
    display:flex;
    align-items:center;
    max-width:1000px;
    width:100%;
    padding:20px;
    border-radius:30px;
    background:rgba(0,0,0,0.1);
    backdrop-filter:blur(10px);
}

#albumImage {
    width:350px;
    height:350px;
    border-radius:15px;
    margin-right:50px;
    box-shadow:0 0 10px rgba(0,0,0,.5);
    transition:opacity .3s ease;
}

#lyrics-container {
    height:120px;
}

.lyric {
    color:rgba(255,255,255,.5);
    font-size:20px;
}
#current-lyric {
    font-size:28px;
    font-weight:bold;
    color:#fff;
}

.progress-bar-container {
    width:100%;
    max-width:1000px;
    margin-top:10px;
    position:relative;
}
.progress-bar {
    height:10px;
    background:#bbbbbb34;
    border-radius:5px;
}
.progress {
    height:100%;
    width:0%;
    background:#ffffff85;
}

#time {
    display:flex;
    justify-content:space-between;
    font-size:12px;
    color:#fff;
}

#songInfo {
    margin-top:20px;
    text-align:center;
}
</style>
</head>

<body>

<div class="main-container">
    <img id="albumImage" src="">
    <div id="lyrics-container">
        <div id="previous-lyric" class="lyric"></div>
        <div id="current-lyric" class="lyric"></div>
        <div id="next-lyric" class="lyric"></div>
    </div>
</div>

<div class="progress-bar-container">
    <div class="progress-bar">
        <div id="progress" class="progress"></div>
    </div>
    <div id="time">
        <span id="elapsed-time">00:00</span>
        <span id="total-time">00:00</span>
    </div>
</div>

<div id="songInfo">
    <h2 id="trackName"></h2>
    <div id="artistName"></div>
</div>

<script>
/* =====================================================
   CONFIG
===================================================== */
const client_id = "f3dc168c6bd742aab6d7e39ab22864dc";
const redirect_uri = "https://11ason.netlify.app/NowPlaying/app";
const scopes = [
    "user-read-currently-playing",
    "user-read-playback-state"
];

let playbackStartTime = 0;
let currentTrackDuration = 0;
let paused = false;
let lyrics = [];
let syncOffset = -2000;

/* =====================================================
   PKCE AUTH
===================================================== */
function randomString(len) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    return Array.from(crypto.getRandomValues(new Uint8Array(len)))
        .map(x => chars[x % chars.length]).join("");
}

async function challenge(verifier) {
    const data = new TextEncoder().encode(verifier);
    const digest = await crypto.subtle.digest("SHA-256", data);
    return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}

async function login() {
    const verifier = randomString(128);
    localStorage.setItem("verifier", verifier);
    const codeChallenge = await challenge(verifier);

    const params = new URLSearchParams({
        client_id,
        response_type:"code",
        redirect_uri,
        scope:scopes.join(" "),
        code_challenge_method:"S256",
        code_challenge:codeChallenge
    });

    location.href = "https://accounts.spotify.com/authorize?" + params;
}

async function exchange(code) {
    const body = new URLSearchParams({
        client_id,
        grant_type:"authorization_code",
        code,
        redirect_uri,
        code_verifier:localStorage.getItem("verifier")
    });

    const r = await fetch("https://accounts.spotify.com/api/token", {
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded" },
        body
    });
    const d = await r.json();

    localStorage.setItem("access_token", d.access_token);
    localStorage.setItem("refresh_token", d.refresh_token);
    localStorage.setItem("expires", Date.now() + d.expires_in * 1000);
}

async function refreshToken() {
    const body = new URLSearchParams({
        client_id,
        grant_type:"refresh_token",
        refresh_token:localStorage.getItem("refresh_token")
    });

    const r = await fetch("https://accounts.spotify.com/api/token", {
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded" },
        body
    });
    const d = await r.json();

    localStorage.setItem("access_token", d.access_token);
    localStorage.setItem("expires", Date.now() + d.expires_in * 1000);
}

async function getToken() {
    const exp = localStorage.getItem("expires");
    if (localStorage.getItem("access_token") && Date.now() < exp - 60000)
        return localStorage.getItem("access_token");

    if (localStorage.getItem("refresh_token")) {
        await refreshToken();
        return localStorage.getItem("access_token");
    }

    login();
}

/* =====================================================
   UI + SPOTIFY DATA
===================================================== */
async function fetchCurrentlyPlaying() {
    const token = await getToken();
    const r = await fetch("https://api.spotify.com/v1/me/player/currently-playing", {
        headers:{ Authorization:"Bearer " + token }
    });

    if (r.status === 204) {
        paused = true;
        return;
    }

    const data = await r.json();
    paused = !data.is_playing;

    updateTrack(data.item, data.progress_ms);
}

function updateTrack(item, progressMs) {
    document.getElementById("trackName").textContent = item.name;
    document.getElementById("artistName").textContent =
        item.artists.map(a => a.name).join(", ");

    const albumUrl = item.album.images[0].url;
    const img = document.getElementById("albumImage");

    if (img.src !== albumUrl) {
        img.style.opacity = 0;
        setTimeout(() => {
            img.src = albumUrl;
            img.style.opacity = 1;
            document.body.style.backgroundImage = `url(${albumUrl})`;
        }, 300);
    }

    playbackStartTime = Date.now() - progressMs;
    currentTrackDuration = item.duration_ms / 1000;

    fetchLyrics(
        item.name,
        item.artists.map(a => a.name).join(", "),
        item.album.name,
        item.duration_ms / 1000
    );
}

function updateProgress() {
    if (paused) return;

    const now = (Date.now() - playbackStartTime) / 1000;
    const percent = Math.min(100, (now / currentTrackDuration) * 100);
    document.getElementById("progress").style.width = percent + "%";

    document.getElementById("elapsed-time").textContent = format(now);
    document.getElementById("total-time").textContent = format(currentTrackDuration);

    displayLyrics();
}

function format(s) {
    const m = Math.floor(s / 60);
    const sec = Math.floor(s % 60);
    return `${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
}

/* =====================================================
   LYRICS
===================================================== */
function fetchLyrics(track, artist, album, duration) {
    fetch(`https://lrclib.net/api/get?track_name=${encodeURIComponent(track)}&artist_name=${encodeURIComponent(artist)}&album_name=${encodeURIComponent(album)}&duration=${duration}`)
        .then(r => r.json())
        .then(d => {
            if (!d.syncedLyrics) return;
            lyrics = d.syncedLyrics.split("\n").map(l => {
                const m = l.match(/\[(\d+):(\d+\.\d+)\]/);
                if (!m) return null;
                return {
                    time: parseInt(m[1]) * 60 + parseFloat(m[2]),
                    text: l.replace(/\[.*?\]/g,"").trim()
                };
            }).filter(Boolean);
        });
}

function displayLyrics() {
    if (!lyrics.length) return;

    const now = (Date.now() - playbackStartTime + syncOffset) / 1000;
    const i = lyrics.findIndex(l => l.time > now);

    document.getElementById("previous-lyric").textContent =
        i > 1 ? lyrics[i-2].text : "";
    document.getElementById("current-lyric").textContent =
        i > 0 ? lyrics[i-1].text : "";
    document.getElementById("next-lyric").textContent =
        i < lyrics.length ? lyrics[i]?.text || "" : "";
}

/* =====================================================
   BOOT
===================================================== */
(async()=>{
    const params = new URLSearchParams(location.search);
    if (params.get("code")) {
        await exchange(params.get("code"));
        history.replaceState({}, document.title, redirect_uri);
    }

    fetchCurrentlyPlaying();
    setInterval(fetchCurrentlyPlaying, 1000);
    setInterval(updateProgress, 250);
})();
</script>
</body>
</html>
