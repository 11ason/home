<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NowPlaying</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Roboto:wght@400;700&family=Lato:wght@400;700&family=Merriweather:wght@400;700&family=Fira+Sans:wght@400;700&family=Nunito:wght@400;700&family=Ubuntu:wght@400;700&family=Funnel+Display:wght@400;700&display=swap" rel="stylesheet">

<style>
/* ---------- EXISTING STYLES (UNCHANGED) ---------- */
body {
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    height:100vh;
    margin:0;
    font-family:"Inter",sans-serif;
    background:#000;
    background-size:cover;
    background-position:center;
    transition:background 1s ease;
    backdrop-filter:blur(100px);
}

.main-container {
    display:flex;
    align-items:center;
    width:100%;
    max-width:1000px;
    background:rgba(0,0,0,0.096);
    padding:20px;
    border-radius:30px;
    backdrop-filter:blur(10px);
}

#albumImage {
    width:350px;
    height:350px;
    border-radius:15px;
    margin-right:50px;
    box-shadow:0 0 10px rgba(0,0,0,.5);
}

.lyric { color:rgba(255,255,255,.5); font-size:20px }
#current-lyric { font-size:28px;font-weight:bold;color:#fff }

.progress-bar-container {
    width:100%;
    max-width:1000px;
    margin-top:10px;
    position:relative;
}
.progress-bar {
    height:10px;
    background:#bbbbbb34;
    border-radius:5px;
}
.progress {
    height:100%;
    width:0%;
    background:#ffffff85;
}

#time {
    display:flex;
    justify-content:space-between;
    font-size:12px;
    color:#fff;
}

/* ---------- DEBUG OVERLAY ---------- */
#debug {
    position:fixed;
    bottom:20px;
    left:20px;
    background:rgba(0,0,0,.6);
    color:#0f0;
    font-family:monospace;
    font-size:11px;
    padding:10px;
    border-radius:10px;
    max-width:300px;
    display:none;
    z-index:99;
}
</style>
</head>

<body>

<div id="debug"></div>

<div class="main-container">
    <img id="albumImage" src="" alt="">
    <div id="lyrics-container">
        <div id="previous-lyric" class="lyric"></div>
        <div id="current-lyric" class="lyric"></div>
        <div id="next-lyric" class="lyric"></div>
    </div>
</div>

<div class="progress-bar-container">
    <div class="progress-bar">
        <div id="progress" class="progress"></div>
    </div>
    <div id="time">
        <span id="elapsed-time">00:00</span>
        <span id="total-time">00:00</span>
    </div>
</div>

<h2 id="trackName"></h2>
<div id="artistName"></div>

<script>
/* =========================================================
   CONFIG
========================================================= */
const client_id = "f3dc168c6bd742aab6d7e39ab22864dc";
const redirect_uri = "https://11ason.netlify.app/NowPlaying/app";
const scopes = [
    "user-read-currently-playing",
    "user-read-playback-state"
];

let playbackStartTime = 0;
let currentTrackDuration = 0;
let paused = false;
let retryDelay = 1000;
let lyrics = [];

/* =========================================================
   PKCE HELPERS
========================================================= */
function randomString(len) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    return Array.from(crypto.getRandomValues(new Uint8Array(len)))
        .map(x => chars[x % chars.length]).join("");
}

async function challenge(verifier) {
    const data = new TextEncoder().encode(verifier);
    const digest = await crypto.subtle.digest("SHA-256", data);
    return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}

async function login() {
    const verifier = randomString(128);
    localStorage.setItem("verifier", verifier);
    const challengeCode = await challenge(verifier);

    const params = new URLSearchParams({
        client_id,
        response_type:"code",
        redirect_uri,
        scope:scopes.join(" "),
        code_challenge_method:"S256",
        code_challenge:challengeCode
    });

    location.href = "https://accounts.spotify.com/authorize?" + params;
}

async function exchange(code) {
    const body = new URLSearchParams({
        client_id,
        grant_type:"authorization_code",
        code,
        redirect_uri,
        code_verifier:localStorage.getItem("verifier")
    });

    const r = await fetch("https://accounts.spotify.com/api/token", {
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded" },
        body
    });
    const d = await r.json();
    saveTokens(d);
}

async function refresh() {
    const body = new URLSearchParams({
        client_id,
        grant_type:"refresh_token",
        refresh_token:localStorage.getItem("refresh_token")
    });

    const r = await fetch("https://accounts.spotify.com/api/token", {
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded" },
        body
    });
    const d = await r.json();
    saveTokens(d);
}

function saveTokens(d) {
    localStorage.setItem("access_token", d.access_token);
    if (d.refresh_token) localStorage.setItem("refresh_token", d.refresh_token);
    localStorage.setItem("expires", Date.now() + d.expires_in*1000);
}

async function token() {
    const exp = localStorage.getItem("expires");
    if (localStorage.getItem("access_token") && Date.now() < exp-60000)
        return localStorage.getItem("access_token");
    if (localStorage.getItem("refresh_token")) {
        await refresh();
        return localStorage.getItem("access_token");
    }
    login();
}

/* =========================================================
   SPOTIFY FETCH + POLISH
========================================================= */
async function fetchPlaying() {
    try {
        const t = await token();
        const r = await fetch("https://api.spotify.com/v1/me/player/currently-playing",{
            headers:{ Authorization:"Bearer "+t }
        });

        if (r.status === 204) { paused=true; return; }
        if (r.status === 429) {
            retryDelay = Math.min(retryDelay*2, 15000);
            return;
        }

        retryDelay = 1000;
        const d = await r.json();
        paused = d.is_playing === false;

        updateTrack(d.item, d.progress_ms);

    } catch(e) {
        debug("Network error, retryingâ€¦");
    }
}

function updateTrack(item, progress) {
    document.getElementById("trackName").textContent = item.name;
    document.getElementById("artistName").textContent =
        item.artists.map(a=>a.name).join(", ");
    document.getElementById("albumImage").src = item.album.images[0].url;

    playbackStartTime = Date.now() - progress;
    currentTrackDuration = item.duration_ms/1000;
}

function updateProgress() {
    if (paused) return;
    const now = (Date.now()-playbackStartTime)/1000;
    document.getElementById("progress").style.width =
        Math.min(100,(now/currentTrackDuration)*100)+"%";
}

/* =========================================================
   DEBUG OVERLAY
========================================================= */
function debug(msg) {
    const d = document.getElementById("debug");
    d.style.display="block";
    d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
}
document.addEventListener("keydown",e=>{
    if(e.key==="`"){
        const d=document.getElementById("debug");
        d.style.display = d.style.display==="none"?"block":"none";
    }
});

/* =========================================================
   BOOT
========================================================= */
(async()=>{
    const params = new URLSearchParams(location.search);
    if (params.get("code")) {
        await exchange(params.get("code"));
        history.replaceState({},document.title,redirect_uri);
    }

    fetchPlaying();
    setInterval(fetchPlaying, retryDelay);
    setInterval(updateProgress, 250);
})();
</script>
</body>
</html>
