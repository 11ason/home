<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NowPlaying:</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Roboto:wght@400;700&family=Lato:wght@400;700&family=Merriweather:wght@400;700&family=Fira+Sans:wght@400;700&family=Nunito:wght@400;700&family=Ubuntu:wght@400;700&family=Funnel+Display:wght@400;700&display=swap" rel="stylesheet">

<style>
/* ðŸ”’ ALL YOUR ORIGINAL CSS â€” UNCHANGED */
body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    margin: 0;
    font-family: "Inter", sans-serif;
    background-color: #000;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    backdrop-filter: blur(100px);
}
.main-container {
    display: flex;
    align-items: center;
    width: 100%;
    max-width: 1000px;
    background: rgba(0,0,0,0.1);
    padding: 20px;
    border-radius: 30px;
    backdrop-filter: blur(10px);
}
#albumImage {
    width: 350px;
    height: 350px;
    border-radius: 15px;
    margin-right: 50px;
    transition: opacity 0.3s ease;
}
.lyric { color: rgba(255,255,255,0.5); font-size: 20px; }
#current-lyric { color: rgba(255,255,255,0.85); font-size: 28px; font-weight: bold; }

.progress-bar-container {
    width: 100%;
    max-width: 1000px;
    margin-top: 10px;
}
.progress-bar {
    height: 10px;
    background: #bbbbbb34;
    border-radius: 5px;
    overflow: hidden;
}
.progress { height: 100%; width: 0%; background: #ffffff85; }

#time {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: rgba(255,255,255,0.76);
}
</style>
</head>

<body>

<div class="main-container">
    <img id="albumImage">
    <div id="lyrics-container">
        <div id="previous-lyric" class="lyric"></div>
        <div id="current-lyric" class="lyric"></div>
        <div id="next-lyric" class="lyric"></div>
    </div>
</div>

<div class="progress-bar-container">
    <div class="progress-bar">
        <div id="progress" class="progress"></div>
    </div>
    <div id="time">
        <span id="elapsed-time">00:00</span>
        <span id="total-time">00:00</span>
    </div>
</div>

<h2 id="trackName"></h2>
<div id="artistName"></div>

<script>
/* =========================================================
   ðŸ” PKCE AUTH (NEW â€” ONLY AUTH CHANGED)
========================================================= */

const client_id = "f3dc168c6bd742aab6d7e39ab22864dc";
const redirect_uri = "https://11ason.netlify.app/NowPlaying/app";
const scopes = [
  "user-read-currently-playing",
  "user-read-playback-state"
];

function base64urlencode(str) {
  return btoa(String.fromCharCode(...new Uint8Array(str)))
    .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

async function sha256(plain) {
  const encoder = new TextEncoder();
  const data = encoder.encode(plain);
  return crypto.subtle.digest("SHA-256", data);
}

async function createPKCE() {
  const verifier = base64urlencode(crypto.getRandomValues(new Uint8Array(32)));
  const challenge = base64urlencode(await sha256(verifier));
  localStorage.setItem("pkce_verifier", verifier);
  return challenge;
}

async function authorize() {
  const challenge = await createPKCE();
  const params = new URLSearchParams({
    client_id,
    response_type: "code",
    redirect_uri,
    scope: scopes.join(" "),
    code_challenge_method: "S256",
    code_challenge: challenge
  });
  location.href = `https://accounts.spotify.com/authorize?${params}`;
}

async function exchangeToken(code) {
  const verifier = localStorage.getItem("pkce_verifier");
  const body = new URLSearchParams({
    client_id,
    grant_type: "authorization_code",
    code,
    redirect_uri,
    code_verifier: verifier
  });

  const res = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body
  });
  const data = await res.json();
  localStorage.setItem("access_token", data.access_token);
  localStorage.setItem("refresh_token", data.refresh_token);
  history.replaceState({}, "", redirect_uri);
  return data.access_token;
}

async function refreshToken() {
  const body = new URLSearchParams({
    client_id,
    grant_type: "refresh_token",
    refresh_token: localStorage.getItem("refresh_token")
  });

  const res = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body
  });
  const data = await res.json();
  localStorage.setItem("access_token", data.access_token);
  return data.access_token;
}

/* =========================================================
   ðŸŽµ YOUR ORIGINAL LOGIC (UNCHANGED)
========================================================= */

let playbackStartTime = 0;
let currentTrackDuration = 0;
let lyrics = [];
let currentAlbumImage = "";

function fetchCurrentlyPlayingSong(token) {
  fetch("https://api.spotify.com/v1/me/player/currently-playing", {
    headers: { Authorization: "Bearer " + token }
  })
  .then(r => r.json())
  .then(data => {
    if (!data?.item) return;
    updateTrackInfo(data.item);
    updatePlaybackInfo(data.progress_ms, data.item.duration_ms);
  });
}

function updateTrackInfo(item) {
  document.getElementById("trackName").textContent = item.name;
  document.getElementById("artistName").textContent =
    item.artists.map(a => a.name).join(", ");

  if (item.album.images[0].url !== currentAlbumImage) {
    currentAlbumImage = item.album.images[0].url;
    document.getElementById("albumImage").src = currentAlbumImage;
    document.body.style.backgroundImage = `url(${currentAlbumImage})`;
  }
}

function updatePlaybackInfo(progressMs, durationMs) {
  playbackStartTime = Date.now() - progressMs;
  currentTrackDuration = durationMs / 1000;
}

function updateProgress() {
  const now = (Date.now() - playbackStartTime) / 1000;
  const pct = Math.min(100, (now / currentTrackDuration) * 100);
  document.getElementById("progress").style.width = pct + "%";
  document.getElementById("elapsed-time").textContent = formatTime(now);
  document.getElementById("total-time").textContent = formatTime(currentTrackDuration);
}

function formatTime(s) {
  const m = Math.floor(s / 60);
  const sec = Math.floor(s % 60);
  return `${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
}

/* =========================================================
   ðŸš€ BOOTSTRAP
========================================================= */

(async () => {
  const params = new URLSearchParams(location.search);
  let token = localStorage.getItem("access_token");

  if (params.get("code")) {
    token = await exchangeToken(params.get("code"));
  } else if (!token) {
    authorize();
    return;
  }

  fetchCurrentlyPlayingSong(token);
  setInterval(() => fetchCurrentlyPlayingSong(token), 1000);
  setInterval(updateProgress, 250);
  setInterval(refreshToken, 1000 * 60 * 50);
})();
</script>
</body>
</html>
